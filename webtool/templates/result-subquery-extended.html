{% set item = subquery %}
{% set can_postprocess = (current_user.is_authenticated and item.postprocessors) %}
<li id="subquery-{{ subquery.key }}" class="subquery{% if not subquery.is_finished() %} running{% endif %}" data-status="{{ subquery.status }}">
    <div class="query-core">
        <p>{{ postprocessors[subquery.type].name if subquery.type in postprocessors else "(Deprecated analysis) " + subquery.type }}

            {% if subquery.is_finished() %}
                (<a href="/result/{{ subquery.result_file }}">{{ subquery.num_rows }} item{% if subquery.num_rows != 1 %}s{% endif %}, {{ postprocessors[subquery.type].extension if subquery.type in postprocessors else "download" }}</a>)
            {% else %}
                ({{ subquery.status }})
            {% endif %}

        {% for option in subquery.parameters %}
            {% if subquery.type in postprocessors and "options" in postprocessors[subquery.type] and option in postprocessors[subquery.type].options %}
                {% if postprocessors[subquery.type].options[option].type == "toggle" %}
        {% if subquery.parameters[option] %}<span class="property-badge">{{ option }}</span>{% endif %}
                {% else %}
        <span class="property-badge">{{ option }}={{ subquery.parameters[option] }}</span>{% endif %}
            {% endif %}
        {% endfor %}
    {% if not item.is_finished() %}
    </div>
    {% else %}
    </p><button class="expand-postprocessors" aria-controls="{{ item.key }}-sub">
            {% if can_postprocess %}{{ item.postprocessors|length }} further analys{% if item.postprocessors|length == 1 %}i{% else %}e{% endif %}s{% endif %}
            {% if can_postprocess and item.subqueries %}and{% endif %}
            {% if item.subqueries %}{{ item.subqueries|length }} further result{% if item.subqueries|length != 1 %}s{% endif %}{% endif %}
            {% if not can_postprocess and not item.subqueries %}details{% endif %}
        </button>
        {% if postprocessors[subquery.type].extension == "html" or postprocessors[subquery.type].extension == "png" or postprocessors[subquery.type].extension == "jpg" or postprocessors[subquery.type].extension == "gif" %}
            <div class="query-result">
            {% if postprocessors[subquery.type].extension == "html" %}
                <iframe class="query-result-iframe" src="/result/{{ subquery.result_file }}"></iframe>
            {% elif postprocessors[subquery.type].extension == "png" or postprocessors[subquery.type].extension == "jpg" or postprocessors[subquery.type].extension == "gif" %}
                <img src="/result/{{ subquery.result_file }}"></img>
            {% endif %}
            </div>
        {% endif %}
    </div>
    {% if item.is_finished() %}
    <div class="sub-controls" id="{{ item.key }}-sub">
        <ul class="subquery-list" aria-expanded="false">
            {% for subquery in item.subqueries %}
                {% include "result-subquery-extended.html" %}
            {% endfor %}
        </ul>
        <p class="details-only">
            {{ postprocessors[item.type].description if item.type in postprocessors else "This post-processor has been deprecated but you can still download the result." }}
        </p>
        <p class="details-only">
            <a class="permalink" href="/results/{{ query.key }}/#nav={{ subquery.get_breadcrumbs() }}" target="_blank">Permanent link to this analysis result (with context)</a>
        </p>
        {% if current_user.is_admin() and item.get_version_url("backend/postprocessors/" + postprocessors[item.type].file) %}
        <p class="details-only">
            <a class="permalink" href="{{ item.get_version_url("backend/postprocessors/" + postprocessors[item.type].file) }}" target="_blank">Review the code that generated this result</a>
        </p>
        {% endif %}
        {% if can_postprocess %}
        <div class="postprocessor-wrap details-only" aria-expanded="true">
            <h4 class="section-subheader">Available analyses</h4>
            <ul class="postprocessor-list">
                {% for processor in item.postprocessors.values() %}
                    {% set query = item %}
                    {% set inline = true %}
                    {% include "postprocessor-details.html" %}
                    {% set inline = false %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}
    {% endif %}
</li>