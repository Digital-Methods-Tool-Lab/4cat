<section class="result-tree">
{% if messages %}
    {% for message in messages %}
        <p class="result-warning glued">{{ message }}</p>
    {% endfor %}
{% endif %}

<div class="card query">
    <h3 class="blocktitle"><span><a href="/results/{{ query.key }}/">Query{% if query.query != "query" %}:
    {{ query.query }}{% endif %}</a></span></h3>

<p class="result">
    <span class="property-badge">{{ query.parameters.datasource if "datasource" in query.parameters else "4chan" }}/{{ query.parameters.board }}/</span>
    {% if query.parameters.body_query and query.parameters.body_query != "empty" %}
        <span class="inline-label">body:</span> <span class="inline-query">{{ query.parameters.body_query }}</span>
    {% endif %}
    {% if query.parameters.subject_query and query.parameters.subject_query != "empty" %}
        <span class="inline-label">subject:</span>
        <span class="inline-query">{{ query.parameters.subject_query }}</span>
    {% endif %}
    {% if query.parameters.country_flag %}
        <span class="inline-label">country:</span>
        <span class="inline-query">{{ query.parameters.country_flag }}</span>
    {% endif %}
    {% if query.parameters.full_thread %}
        <span class="property-badge second-tier">full thread</span>
    {% endif %}
    {% if query.parameters.random_amount and query.parameters.random_amount > 0 %}
        <span class="property-badge second-tier">random sample={{ query.parameters.random_amount }}</span>
    {% endif %}
    {% if query.parameters.dense_threads %}
        <span class="property-badge second-tier">dense threads ({{ query.parameters.dense_percentage }}%/&gt; {{ query.parameters.dense_length }})</span>
    {% endif %}
    {% if query.parameters.dense_country_percentage %}
        <span class="property-badge second-tier">country-dense threads ({{ query.parameters.dense_country_percentage }}%)</span>
    {% endif %}
    {%  if query.is_finished and query.num_rows == 0 %}
        <span class="property-badge second-tier warning">no results</span>
    {% endif %}

{% if query.parameters.min_date > 0 or query.parameters.max_date > 0 %}
        {% if query.parameters.min_date > 0 %}
            <span class="property-badge">From</span>
            <span class="inline-query">{{ query.parameters.min_date|datetime }}</span>
        {% endif %}{% if query.parameters.max_date > 0 %}
        <span class="property-badge">Until</span>
        <span class="inline-query">{{ query.parameters.max_date|datetime }}</span>
    {% endif %}
{% endif %}
    </p>

    <p class="result">
        Queued on {{ query.timestamp|datetime(fmt="%Y-%m-%d %H:%m") }}.
    </p>

    <!--{% if query.num_rows > 0 and query.is_finished %}
    <div class="query-result">
        <iframe class="query-result-iframe csvfile" src="/preview-csv/{{ query.key }}/"></iframe>
    </div>
    {% endif %}-->

    <p class="result">
        {% if query.status %}{{ query.status }}{% else %}Query is queued.{% endif %} {% if query.is_finished %}({{ query.num_rows }} posts{% if query.num_rows > 0 %}; <a href="/result/{{ query.result_file }}">{{ query.result_file }}</a>{% endif %}){% endif %}
    </p>
</div>

    <div id="{{ query.key }}-sub">
    <ol class="subquery-list">
        {% for subquery in query.subqueries %}
            {% include 'result-subquery-extended.html' %}
        {% endfor %}
    </ol>
    </div>
</section>

<article>
{% if current_user.is_authenticated %}
    {% if query.num_rows == 0 or query.postprocessors|length == 0 %}
        <h3 class="blocktitle section-header"><span>Analyses</span></h3>
        <p>
            No further analytical post-processors are available for this query.
            {% if subqueries|length > 0 %}
                Results for analyses that were run earlier are available in the panel above.
            {% endif %}
        </p>
    {% else %}
        {% set part = "main" %}
        <h3 class="blocktitle section-header"><span>Select analysis</span></h3>
        {% if is_postprocessor_running %}
            <p class="result-warning glued">Further analyses may be queued once all analyses currently queued for this
                result have been completed.</p>
        {% endif %}

        <p>Start your analysis of the retrieved data by choosing one of the post-processors below.
        Note that some may take a while to complete, so carefully consider which one you want to run
        before queueing it.</p>
        <p><a href="#">Documentation</a> about the various modes of analysis and what to take into
        account when using 4CAT data is available as well.</p>


        {% set cat = namespace(egory='') %}
        {% for processor in query.postprocessors.values() %}
            {% if processor.category != cat.egory %}
                {% if cat.egory != '' %}</ol>{% endif %}
                {% set cat.egory = processor.category %}
                <h4 class="blocktitle section-subheader"><span>{{ processor.category }}</span></h4>
                <ol class="postprocessor-list">
            {% endif %}
            {% include "postprocessor-details.html" %}
        {% endfor %}
    {% endif %}
{% endif %}
</article>